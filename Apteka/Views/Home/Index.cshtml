<!-- /.row -->
<div class="row">
    <div class="col-md-9">
        <div class="panel panel-default">
            <div class="panel-heading">
                <i class="fa fa-bar-chart-o fa-fw"></i> Dzisiejsza Sprzedaż

            </div>
            <div class="panel-body">
                <div id="TodaySales" style="height:300px;"></div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="panel panel-default">
            <div class="panel-heading">
                <i class="fa fa-bar-chart-o fa-fw"></i> Zobacz także
            </div>
            <div class="panel-body">
                <div id="SoldDaily" style="height:150px;"></div>
                <div id="BoughtDaily" style="height:150px;"></div>                
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="panel panel-default">
            <div class="panel-heading">
                <i class="fa fa-bar-chart-o fa-fw"></i> Zyski miesięczne

            </div>
            <div class="panel-body">
                <div id="MonthlySummary" style="height:400px;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    function getPromise(url) {
        return new Promise(function(resolve, reject) {
            $.get(url, function(data){
                resolve(data);
            });
        });
    }

    function toDate(date) {
        var a = new Date(parseInt(date.substr(6)));
        return a.getTime();
    }

    function toHour(date) {
        var a = new Date(parseInt(date.substr(6)));
        a.setTime(a.getTime() + 2 * 60 * 1000);
        return a.getTime();
    }

    var today = new Date();
    today.setHours(0, 0, 0, 0);

    Highcharts.setOptions({
        global: {
            useUTC: false
        }
    });

    $(function () {
        getPromise("/Chart/SalesToday").then(function (dane) {
            var later = new Date();
            later.setTime(today.getTime() + (1 * 24 * 60 * 60 * 1000))
            var serier = [{
                yAxis: 0,
                name: "Sprzedaż",
                data: _.map(dane, function (i) { return [toHour(i.Date), i.Count]; })
            }];
            console.log(serier);
            $('#TodaySales').highcharts({
                title: {
                    text: ''
                },
                subtitle :{
                    text: ''
                },
                xAxis: {
                    title: {
                        text: 'Godzina'
                    },
                    type: 'datetime',
                    tickInterval: 3600 * 1000,
                    min: today.getTime(),
                    max: later.getTime()
                },
                yAxis: [{
                    title: {
                        text: 'Sprzedaż'
                    },
                    min: 0
                }],
                tooltip: {
                    headerFormat: '<b>{series.name}</b><br>'
                },
                series: serier
            });
        });
        Promise.all([getPromise("/Chart/SoldDaily?days=31"), getPromise("/Chart/ExpensesDaily?days=31")]).then(function (dane) {
            var start = new Date();
            start.setTime(today.getTime() - (31 * 24 * 60 * 60 * 1000));
            var serier = [{
                yAxis: 0,
                name: 'Rozchód',
                data: _.map(dane[0], function (i) { return [toDate(i.Date), i.Count]; })
            }, {
                yAxis: 1,
                name: 'Przychód',
                data: _.map(dane[1], function (i) { return [toDate(i.Date), i.Count]; })
            }];
            console.log(serier);
            $('#MonthlySummary').highcharts({
                title: {
                    text: ''
                },
                subtitle: {
                    text: ''
                },
                xAxis: {
                    type: 'datetime',
                    tickInterval: 24 * 3600 * 1000,
                    min: start.getTime(),
                    max: today.getTime(),
                    dateTimeLabelFormats: { // don't display the dummy year
                        month: '%e. %b',
                        year: '%b'
                    },
                    title: {
                        text: 'Data'
                    }
                },
                yAxis: [{
                    title: {
                        text: 'Przychód'
                    },
                    min: 0
                },
                {
                    title: {
                        text: 'Rozchód'
                    },
                    min: 0
                }],
                tooltip: {
                    headerFormat: '<b>{series.name}</b><br>',
                    pointFormat: '{point.x:%e. %b}: {point.y:.2f}'
                },

                plotOptions: {
                    spline: {
                        marker: {
                            enabled: true
                        }
                    }
                },
                series: serier
            });
        });
        getPromise("/Chart/SoldDaily?days=14").then(function (dane) {
            var start = new Date();
            start.setTime(today.getTime() - (14 * 24 * 60 * 60 * 1000));
            var serier = [{
                showInLegend: false,
                yAxis: 0,
                name: "Sprzedaż",
                data: _.map(dane, function (i) { return [toHour(i.Date), i.Count]; })
            }];
            console.log(serier);
            $('#SoldDaily').highcharts({
                title: {
                    text: ''
                },
                subtitle: {
                    text: ''
                },
                xAxis: {
                    type: 'datetime',
                    tickInterval: 24 * 3600 * 1000,
                    min: start.getTime(),
                    max: today.getTime(),
                    dateTimeLabelFormats: { // don't display the dummy year/month
                        day: '%e',
                        month: '%e',
                        year: '%e'
                    },
                    title: {
                        text: 'Dzień'
                    }
                },
                yAxis: [{
                    title: {
                        text: 'Sprzedaż'
                    },
                    min: 0
                }],
                tooltip: {
                    headerFormat: '<b>{series.name}</b><br>',
                    pointFormat: '{point.x:%e. %b}: {point.y:.0f}'
                },

                plotOptions: {
                    spline: {
                        marker: {
                            enabled: true
                        }
                    }
                },
                series: serier
            });
        });
        getPromise("/Chart/BoughtDaily?days=14").then(function (dane) {
            var start = new Date();
            start.setTime(today.getTime() - (14 * 24 * 60 * 60 * 1000));
            var serier = [{
                showInLegend: false,
                yAxis: 0,
                name: "Zakup",
                data: _.map(dane, function (i) { return [toHour(i.Date), i.Count]; })
            }];
            console.log(serier);
            $('#BoughtDaily').highcharts({
                title: {
                    text: ''
                },
                subtitle: {
                    text: ''
                },
                xAxis: {
                    type: 'datetime',
                    tickInterval: 24 * 3600 * 1000,
                    min: start.getTime(),
                    max: today.getTime(),
                    dateTimeLabelFormats: { // don't display the dummy year/month
                        day: '%e',
                        month: '%e',
                        year: '%e'
                    },
                    title: {
                        text: 'Dzień'
                    }
                },
                yAxis: [{
                    title: {
                        text: 'Zakup'
                    },
                    min: 0
                }],
                tooltip: {
                    headerFormat: '<b>{series.name}</b><br>',
                    pointFormat: '{point.x:%e. %b}: {point.y:.0f}'
                },

                plotOptions: {
                    spline: {
                        marker: {
                            enabled: true
                        }
                    }
                },
                series: serier
            });
        });
    });
</script>